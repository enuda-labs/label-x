services:
  web:
    build:
      context: .
      dockerfile: Dockerfile.prod
    ports:
      - "8003:8003"
    env_file:
      - .env
    environment:
      - PYTHONUNBUFFERED=1
      - DJANGO_SETTINGS_MODULE=label_x.settings
      - DEBUG_VALUE=false
      - IS_PRODUCTION=true
      # DATABASE_URL should be set in .env file pointing to Digital Ocean managed database
      - CELERY_BROKER_URL=redis://label-x-redis:6379/0
      # CELERY_RESULT_BACKEND is set to 'django-db' in settings.py for django-celery-results
      - REDIS_CACHE_BACKEND=redis://label-x-redis:6379/1
    restart: unless-stopped
    depends_on:
      - label-x-redis
    volumes:
      # Only mount necessary production volumes
      - static_volume:/app/staticfiles
      - ./logs:/app/logs
    command: sh -c "python manage.py migrate --noinput && python manage.py collectstatic --noinput && python manage.py seed_plans && python manage.py seed_domains && python manage.py seed_system_settings && daphne label_x.asgi:application --port 8003 --bind 0.0.0.0 -v2"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8003/api/docs/", "||", "exit", "1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  label-x-redis:
    image: redis:7-alpine
    container_name: label-x-redis
    restart: unless-stopped
    ports:
      - "6383:6379"  # Maps host port 6383 to container's internal Redis port 6379
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes --maxmemory 512mb --maxmemory-policy allkeys-lru
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3

  celery:
    build:
      context: .
      dockerfile: Dockerfile.prod
    command: celery -A label_x worker --loglevel=info --concurrency=6 --queues=default,ai_queue,urgent_queue,normal_queue,low_queue
    env_file:
      - .env
    environment:
      - PYTHONUNBUFFERED=1
      - DJANGO_SETTINGS_MODULE=label_x.settings
      - DEBUG_VALUE=false
      - IS_PRODUCTION=true
      - CELERY_BROKER_URL=redis://label-x-redis:6379/0
      # CELERY_RESULT_BACKEND is set to 'django-db' in settings.py for django-celery-results
      - REDIS_CACHE_BACKEND=redis://label-x-redis:6379/1
    restart: unless-stopped
    depends_on:
      - label-x-redis
      - web
    volumes:
      - ./logs:/app/logs
    healthcheck:
      test: ["CMD", "celery", "-A", "label_x", "inspect", "ping"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 60s

  celery-beat:
    build:
      context: .
      dockerfile: Dockerfile.prod
    command: celery -A label_x beat --loglevel=info --scheduler django_celery_beat.schedulers:DatabaseScheduler
    env_file:
      - .env
    environment:
      - PYTHONUNBUFFERED=1
      - DJANGO_SETTINGS_MODULE=label_x.settings
      - DEBUG_VALUE=false
      - IS_PRODUCTION=true
      - CELERY_BROKER_URL=redis://label-x-redis:6379/0
      # CELERY_RESULT_BACKEND is set to 'django-db' in settings.py for django-celery-results
      - REDIS_CACHE_BACKEND=redis://label-x-redis:6379/1
    restart: unless-stopped
    depends_on:
      - label-x-redis
      - web
    volumes:
      - ./logs:/app/logs
      - celerybeat_data:/app
    healthcheck:
      test: ["CMD", "test", "-f", "/app/celerybeat-schedule", "||", "exit", "1"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 60s

  nginx:
    image: nginx:alpine
    container_name: label-x-nginx
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/sites-available:/etc/nginx/sites-available:ro
      - ./nginx/sites-enabled:/etc/nginx/sites-enabled:ro
      - /etc/letsencrypt:/etc/letsencrypt:ro
      - /var/www/certbot:/var/www/certbot
      - static_volume:/app/staticfiles:ro
    depends_on:
      - web
    healthcheck:
      test: ["CMD", "nginx", "-t"]
      interval: 30s
      timeout: 10s
      retries: 3

volumes:
  static_volume:
  redis_data:
  celerybeat_data:

networks:
  default:
    name: label-x-network
    driver: bridge

